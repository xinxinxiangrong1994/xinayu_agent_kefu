# 闲鱼智能客服 RPA - 功能更新方案文档

**版本**: v1.1
**更新日期**: 2026-01-06
**文档目的**: 记录本次功能迭代的技术方案和实现细节

---

## 一、功能概述

本次更新主要包含以下功能模块：

1. **订单状态字段传递** - 将买家订单状态传递给 Coze 工作流
2. **系统消息过滤** - 过滤闲鱼系统通知，避免触发自动回复
3. **日志优化** - 减少日志刷屏，提升可读性
4. **GUI 改进** - 窗口可拉伸、详细日志开关

---

## 二、订单状态字段传递

### 2.1 功能描述

从闲鱼页面提取订单状态信息，作为辅助参数传递给 Coze 工作流，帮助 AI 更准确地理解用户意图和上下文。

### 2.2 状态提取来源

订单状态从两个位置提取（优先级从高到低）：

1. **商品卡片**（聊天区域右侧）- 优先使用
2. **会话列表**（左侧列表项）- 备选

### 2.3 状态值映射表

为避免传递动作指示性文字，将闲鱼原始状态映射为简化状态：

| 闲鱼原始显示 | 传给 Coze 的值 | 说明 |
|-------------|---------------|------|
| 等待买家付款 | `待付款` | 订单已创建，买家未付款 |
| 待付款 | `待付款` | 订单已创建，买家未付款 |
| 已付款 | `已付款` | 买家已完成付款 |
| 等待卖家发货 | `已付款` | 买家已付款，等待发货 |
| 已发货 | `已发货` | 商品已寄出 |
| 等待买家收货 | `已发货` | 商品在途中 |
| 已收货 | `已收货` | 买家已签收 |
| 交易成功 | `已完成` | 交易结束 |
| 交易关闭 | `已关闭` | 交易关闭 |
| 交易取消 | `已取消` | 交易取消 |
| 等待见面交易 | `待见面` | 线下交易 |
| 退款中 | `退款中` | 退款处理中 |
| 已退款 | `已退款` | 退款完成 |

### 2.4 Coze 工作流变量

在 `config.py` 中定义的变量常量：

```python
class CozeVars:
    BUYER_NAME = "buyer_name"        # 买家用户名
    PRODUCT_TITLE = "product_title"  # 商品标题
    PRODUCT_PRICE = "product_price"  # 商品价格
    ORDER_STATUS = "order_status"    # 订单状态
```

### 2.5 传递方式

通过 Coze API 的 `parameters` 和 `custom_variables` 字段传递：

```python
payload["custom_variables"] = custom_vars  # 替换提示词模板中的 {{variable}}
payload["parameters"] = custom_vars         # 工作流开始节点的输入参数
```

### 2.6 代码位置

- **状态提取**: `xianyu_browser.py`
  - `get_conversation_list()` - 会话列表状态提取
  - `get_product_info()` - 商品卡片状态提取
- **变量构建**: `config.py` - `CozeVars.build()` 方法
- **API 调用**: `coze_client.py` - `chat()` 方法

---

## 三、系统消息过滤

### 3.1 功能描述

识别并过滤闲鱼系统通知消息（如下单、付款、发货通知），避免这些消息触发 AI 自动回复。

### 3.2 系统消息关键词

以下消息内容会被标记为系统消息：

```javascript
const systemMessageKeywords = [
    '我已拍下，待付款',
    '我已付款，等待你发货',
    '请双方沟通及时确认价格',
    '请包装好商品',
    '你已发货',
    '已发货，等待买家确认',
    '买家已确认收货',
    '交易成功',
    '交易关闭',
    '订单已取消',
    '退款成功',
    '申请退款',
    '你撤回了一条消息',
    '对方撤回了一条消息',
    '对方正在输入',
];
```

### 3.3 实现方式

1. **消息数据结构扩展**：
   ```python
   @dataclass
   class Message:
       sender: str        # "buyer" 或 "seller"
       content: str       # 消息内容
       timestamp: str = ""
       is_system: bool = False  # 是否为系统消息
   ```

2. **消息处理逻辑**：
   ```python
   # 找到最后一条买家消息（跳过系统消息）
   for msg in reversed(messages):
       if msg.sender == "buyer" and not msg.is_system:
           last_buyer_message = msg.content
           break
   ```

### 3.4 代码位置

- **消息提取**: `xianyu_browser.py` - `get_current_conversation_messages()`
- **消息处理**: `message_handler.py` - `_handle_conversation()`

---

## 四、日志优化

### 4.1 问题描述

原有实现中，每次检查会话都会输出日志，导致日志刷屏，影响重要信息的可读性。

### 4.2 优化方案

| 日志内容 | 原级别 | 新级别 | 说明 |
|---------|--------|--------|------|
| 找到 X 个会话 | INFO | DEBUG | 只在详细模式显示 |
| 找到 X 个未读会话 | INFO | 条件 INFO | 仅当 X > 0 时显示 |
| 切换会话失败 | ERROR | DEBUG | 降级为调试日志 |
| 获取商品信息失败 | ERROR | DEBUG | 降级为调试日志 |

### 4.3 代码位置

- `xianyu_browser.py` - `get_conversation_list()`, `get_unread_conversations()`

---

## 五、GUI 改进

### 5.1 窗口可拉伸

```python
self.root.geometry("600x800")
self.root.minsize(520, 700)      # 最小尺寸
self.root.resizable(True, True)  # 允许拉伸
```

### 5.2 详细日志开关

添加"显示详细日志"复选框，切换日志级别：

- **关闭**（默认）: 只显示 INFO 及以上级别
- **开启**: 显示 DEBUG 及以上级别

```python
def _toggle_debug_logs(self):
    level = "DEBUG" if self.show_debug_logs else "INFO"
    self.log_handler_id = logger.add(
        self.gui_handler.write,
        format="{time:HH:mm:ss} | {level} | {message}",
        level=level
    )
```

### 5.3 代码位置

- `gui.py` - `_create_widgets()`, `_toggle_debug_logs()`

---

## 六、Coze 工作流配置建议

为确保 AI 正确使用订单状态信息，建议在 Coze 工作流提示词中添加以下规则：

```
【重要规则】
1. 首先理解并直接回答用户的问题
2. 只有当用户询问订单/物流/付款相关问题时，才提及订单状态
3. 对于简单问候（如"在吗"、"你好"），直接友好回应即可

【可用信息】
- 买家名称: {{buyer_name}}
- 商品标题: {{product_title}}
- 商品价格: {{product_price}}
- 订单状态: {{order_status}}

【回复示例】
用户: 在吗
回复: 在的亲，有什么可以帮您的吗？

用户: 发货了吗
回复: 亲，您的订单当前状态是{{order_status}}，请耐心等待哦~
```

---

## 七、文件修改清单

| 文件 | 修改内容 |
|------|---------|
| `xianyu_browser.py` | 订单状态提取与映射、系统消息过滤、日志级别调整 |
| `config.py` | 添加 `ORDER_STATUS` 常量和 `CozeVars.build()` 方法 |
| `message_handler.py` | 传递订单状态、跳过系统消息 |
| `coze_client.py` | 通过 `parameters` 传递工作流变量 |
| `gui.py` | 窗口可拉伸、详细日志开关 |

---

## 八、版本历史

| 版本 | 日期 | 更新内容 |
|------|------|---------|
| v1.0 | - | 初始版本 |
| v1.1 | 2026-01-06 | 订单状态传递、系统消息过滤、日志优化、GUI改进 |

---

*文档结束*
